name: Syllabus Update Cron

on:
  schedule:
    - cron: '0 15 * * *' # ÊØéÊó•JST: 0ÊôÇ (UTC: 15ÊôÇ)„Å´ÂÆüË°å
  workflow_dispatch:

jobs:
  update-syllabus:
    runs-on: ubuntu-latest
    env:
      REQUEST_URL: 'https://syllahub.pages.dev/api/updateSyllabus'

    steps:
      - name: Show execution time
        run: |
          echo "üïí Cron job started at:"
          echo "UTC: $(date -u)"
          echo "JST: $(TZ='Asia/Tokyo' date)"
      - name: Validate and prepare credentials
        env:
          CRON_USERNAME: ${{ secrets.CRON_USERNAME }}
          CRON_PASSWORD: ${{ secrets.CRON_PASSWORD }}
        run: |
          set -e
          echo "üîç Validating credentials..."

          if [ -z "$CRON_USERNAME" ] || [ -z "$CRON_PASSWORD" ]; then
            echo "‚ùå Error: Missing credentials"
            exit 1
          fi

          AUTH_HEADER="Authorization: Basic $(echo -n "$CRON_USERNAME:$CRON_PASSWORD" | base64)"
          echo "::add-mask::$AUTH_HEADER"

          echo "AUTH_HEADER=$AUTH_HEADER" >> $GITHUB_ENV
          echo "‚úÖ Credentials validated and masked"

      - name: Execute API call
        run: |
          echo "üéì Starting syllabus site update..."
          echo "üöÄ Making PUT request to: $REQUEST_URL"

          if RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "$AUTH_HEADER" \
            -H "Content-Type: application/json" \
            "$REQUEST_URL" 2>&1); then

            HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

            echo "üìä HTTP Status: $HTTP_STATUS"

            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo "üéâ Syllabus data updated successfully!"
              echo "üìù Response: $RESPONSE_BODY"
              COUNT=$(echo "$RESPONSE_BODY" | jq -r '.count // empty')
              if [ -n "$COUNT" ]; then
                echo "üì¶ Updated syllabus count: $COUNT"
              fi
            else
              echo "‚ùå Syllabus update failed with status: $HTTP_STATUS"
              echo "üìù Error response: $RESPONSE_BODY"
              exit 1
            fi
          else
            echo "‚ùå Failed to connect to syllabus API"
            exit 1
          fi
